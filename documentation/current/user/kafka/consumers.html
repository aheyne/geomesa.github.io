

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Data Consumers &mdash; GeoMesa 1.3.2-SNAPSHOT Manuals</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../_static/css/theme_custom.css" type="text/css" />
  

  
    <link rel="stylesheet" href="../../_static/sphinx_tabs/tabs.css" type="text/css" />
  
    <link rel="stylesheet" href="../../_static/sphinx_tabs/semantic-ui-2.2.7/segment.min.css" type="text/css" />
  
    <link rel="stylesheet" href="../../_static/sphinx_tabs/semantic-ui-2.2.7/menu.min.css" type="text/css" />
  
    <link rel="stylesheet" href="../../_static/sphinx_tabs/semantic-ui-2.2.7/tab.min.css" type="text/css" />
  

  
    <link rel="top" title="GeoMesa 1.3.2-SNAPSHOT Manuals" href="../../index.html"/> 

  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../index.html" class="icon icon-home"> GeoMesa
          

          
          </a>

          
            
            
              <div class="version">
                1.3.2-SNAPSHOT
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul>
<li class="toctree-l1"><a class="reference internal" href="../index.html">User Manual</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../developer/index.html">Developer Manual</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tutorials/index.html">Tutorials</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../index.html">GeoMesa</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          





<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../index.html">Docs</a> &raquo;</li>
      
    <li>Data Consumers</li>
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../../_sources/user/kafka/consumers.txt" rel="nofollow"> View page source</a>
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="data-consumers">
<h1>Data Consumers<a class="headerlink" href="#data-consumers" title="Permalink to this headline">¶</a></h1>
<p>A GeoMesa Kafka data store in <em>consumer</em> mode reads feature data written
to Kafka (by a separate GeoMesa Kafka producer). The store supports two types of
<tt class="docutils literal"><span class="pre">SimpleFeatureSource</span></tt>&#8216;s: <em>live</em> and <em>replay</em>. A Kafka Consumer Feature
Source operating in <em>live</em> mode continually pulls data from the end of
the message queue (e.g. latest time) and always represents the latest
state of the simple features; <tt class="docutils literal"><span class="pre">autoOffsetReset</span></tt> can be set to <tt class="docutils literal"><span class="pre">smallest</span></tt>
to read from the beginning of the the message queue. A Kafka Consumer Feature
Source operating in <em>replay</em> mode will pull data from a specified time interval
in the past and can provide features as they existed at any point in time
within that interval.</p>
<p>First, create the data store. For example:</p>
<div class="highlight-java"><div class="highlight"><pre><span class="n">String</span> <span class="n">brokers</span> <span class="o">=</span> <span class="o">...</span>
<span class="n">String</span> <span class="n">zookeepers</span> <span class="o">=</span> <span class="o">...</span>
<span class="n">String</span> <span class="n">zkPath</span> <span class="o">=</span> <span class="o">...</span>

<span class="c1">// build parameters map</span>
<span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Serializable</span><span class="o">&gt;</span> <span class="n">params</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;&gt;();</span>
<span class="n">params</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;brokers&quot;</span><span class="o">,</span> <span class="n">brokers</span><span class="o">);</span>
<span class="n">params</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;zookeepers&quot;</span><span class="o">,</span> <span class="n">zookeepers</span><span class="o">);</span>

<span class="c1">// optional - the default is false</span>
<span class="n">params</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;isProducer&quot;</span><span class="o">,</span> <span class="n">Boolean</span><span class="o">.</span><span class="na">FALSE</span><span class="o">);</span>

<span class="c1">// optional</span>
<span class="n">params</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;zkPath&quot;</span><span class="o">,</span> <span class="n">zkPath</span><span class="o">);</span>

<span class="c1">// optional - can be set to &quot;smallest&quot; to read from the beginning of the message queue</span>
<span class="n">params</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;autoOffsetReset&quot;</span><span class="o">,</span> <span class="s">&quot;largest&quot;</span><span class="o">);</span>

<span class="c1">// create the data store</span>
<span class="n">KafkaDataStoreFactory</span> <span class="n">factory</span> <span class="o">=</span> <span class="k">new</span> <span class="n">KafkaDataStoreFactory</span><span class="o">();</span>
<span class="n">DataStore</span> <span class="n">consumerDs</span> <span class="o">=</span> <span class="n">factory</span><span class="o">.</span><span class="na">createDataStore</span><span class="o">(</span><span class="n">params</span><span class="o">);</span>
</pre></div>
</div>
<p>The <tt class="docutils literal"><span class="pre">brokers</span></tt>, <tt class="docutils literal"><span class="pre">zookeepers</span></tt>, and <tt class="docutils literal"><span class="pre">zkPath</span></tt> parameters must be
consistent with the values used to create the Kafka Data Store Producer.</p>
<p>Because <tt class="docutils literal"><span class="pre">createSchema</span></tt> was called on the Kafka Data Store Producer, it
does not need to be called on the Consumer. Calling <tt class="docutils literal"><span class="pre">createSchema</span></tt>
with a <tt class="docutils literal"><span class="pre">SimpleFeatureType</span></tt> that has already been created will result
in an exception being thrown. Note that all <tt class="docutils literal"><span class="pre">SimpleFeature</span></tt>s
returned by the Kafka Data Store consumer will have a
<tt class="docutils literal"><span class="pre">SimpleFeatureType</span></tt> equal to the <tt class="docutils literal"><span class="pre">streamingSFT</span></tt> created when setting
up the producer, i.e. the <tt class="docutils literal"><span class="pre">SimpleFeatureType</span></tt> will include the hint
added by <tt class="docutils literal"><span class="pre">KafkaDataStoreHelper.createStreamingSFT</span></tt>.</p>
<p>Now that the Kafka Data Store Consumer has been created it can be
queried in either <em>live</em> or <em>replay</em> mode.</p>
<div class="section" id="live-mode">
<h2>Live Mode<a class="headerlink" href="#live-mode" title="Permalink to this headline">¶</a></h2>
<p>Live mode is the default and requires no extra setup. In this mode the
<tt class="docutils literal"><span class="pre">SimpleFeatureSource</span></tt> contains the current state of the
<tt class="docutils literal"><span class="pre">KafkaDataStore</span></tt>. As <tt class="docutils literal"><span class="pre">SimpleFeatures</span></tt> are created, modified,
deleted, or cleared by the Kafka Data Store Producer, the current state
is updated. All queries to the <tt class="docutils literal"><span class="pre">SimpleFeatureSource</span></tt> are queries
against the current state. For example:</p>
<div class="highlight-java"><div class="highlight"><pre><span class="n">String</span> <span class="n">typeName</span> <span class="o">=</span> <span class="o">...</span>
<span class="n">SimpleFeatureSource</span> <span class="n">liveFeatureSource</span> <span class="o">=</span> <span class="n">consumerDs</span><span class="o">.</span><span class="na">getFeatureSource</span><span class="o">(</span><span class="n">typeName</span><span class="o">);</span>

<span class="n">Filter</span> <span class="n">filter</span> <span class="o">=</span> <span class="o">...</span>
<span class="n">liveFeatureSource</span><span class="o">.</span><span class="na">getFeatures</span><span class="o">(</span><span class="n">filter</span><span class="o">);</span>
</pre></div>
</div>
<p>It is also possible to provide a CQL filter to the getFeatureSource method call which will ensure
the resulting <tt class="docutils literal"><span class="pre">FeatureSource</span></tt> only contains certain records. Providing a filter to reduce the number of
returned records will provide a performance boost when using the featureSource.</p>
<div class="highlight-java"><div class="highlight"><pre><span class="n">String</span> <span class="n">typeName</span> <span class="o">=</span> <span class="o">...</span>
<span class="n">SimpleFeatureSource</span> <span class="n">liveFeatureSource</span> <span class="o">=</span> <span class="n">consumerDs</span><span class="o">.</span><span class="na">getFeatureSource</span><span class="o">(</span><span class="n">typeName</span><span class="o">,</span> <span class="n">filter</span><span class="o">);</span>
</pre></div>
</div>
</div>
<div class="section" id="replay-mode">
<h2>Replay Mode<a class="headerlink" href="#replay-mode" title="Permalink to this headline">¶</a></h2>
<p>Replay mode allows the a user to query the <tt class="docutils literal"><span class="pre">KafkaDataStore</span></tt> as it
existed at any point in the past. Queries against a Kafka Replay Simple
Feature source specify a historical time to query and only the set and
version of <tt class="docutils literal"><span class="pre">SimpleFeature</span></tt>s that existed at that point in time will
be used to answer the query.</p>
<p>In order to use Replay mode some additional hints are required: the
start and end times of the replay window and a read behind duration:</p>
<div class="highlight-java"><div class="highlight"><pre><span class="n">Instant</span> <span class="n">replayStart</span> <span class="o">=</span> <span class="o">...</span>
<span class="n">Instant</span> <span class="n">replayEnd</span> <span class="o">=</span> <span class="o">...</span>
<span class="n">Duration</span> <span class="n">readBehind</span> <span class="o">=</span> <span class="o">...</span>
<span class="n">ReplayConfig</span> <span class="n">replayConfig</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ReplayConfig</span><span class="o">(</span><span class="n">replayStart</span><span class="o">,</span> <span class="n">replayEnd</span><span class="o">,</span> <span class="n">readBehind</span><span class="o">);</span>
</pre></div>
</div>
<p>The replay window is simply an optimization that allows the Kafka Replay
Feature Source to load, at initialization time, all state changes that
occur within the window. Any query for a time outside of the window will
return no results even if features existed at that time.</p>
<p>The read behind is the amount of time used to rebuild state. For
example, if <tt class="docutils literal"><span class="pre">readBehind</span> <span class="pre">=</span> <span class="pre">5s</span></tt> then for a query requesting state at
<tt class="docutils literal"><span class="pre">time</span> <span class="pre">=</span> <span class="pre">t</span></tt> all state changes that occurred between <tt class="docutils literal"><span class="pre">t</span> <span class="pre">-</span> <span class="pre">5s</span></tt> and
<tt class="docutils literal"><span class="pre">t</span></tt> will be used to build the state at time <tt class="docutils literal"><span class="pre">t</span></tt> which will then be
used to answer the query. Selecting an appropriate read behind requires
an understanding of the producer. The expected use case is a producer
that updates every simple feature, even if it hasn&#8217;t changed, at a
regular interval. For example, if the producer is updating every <tt class="docutils literal"><span class="pre">x</span></tt>
seconds then a read behind of <tt class="docutils literal"><span class="pre">x</span> <span class="pre">+</span> <span class="pre">1s</span></tt> might be appropriate.</p>
<p>During initialization of the Kafka Replay Feature Source all state
changes from <tt class="docutils literal"><span class="pre">replayStart</span> <span class="pre">-</span> <span class="pre">readBehind</span></tt> to <tt class="docutils literal"><span class="pre">replayEnd</span></tt> will be read
and cached. As the size of the replay window and read behind increases
so does the amount of data that must be read and cashed. So, both the
size of the window and the read behind should be kept as small as
possible.</p>
<p>After creating the <tt class="docutils literal"><span class="pre">ReplayConfig</span></tt>, pass it, along with the
<tt class="docutils literal"><span class="pre">streamingSFT</span></tt>, to the <tt class="docutils literal"><span class="pre">KafkaDataStoreHelper</span></tt>:</p>
<div class="highlight-java"><div class="highlight"><pre><span class="n">SimpleFeatureType</span> <span class="n">streamingSFT</span> <span class="o">=</span> <span class="n">consumerDs</span><span class="o">.</span><span class="na">getSchema</span><span class="o">(</span><span class="n">typeName</span><span class="o">);</span>
<span class="n">SimpleFeatureType</span> <span class="n">replaySFT</span> <span class="o">=</span> <span class="n">KafkaDataStoreHelper</span><span class="o">.</span><span class="na">createReplaySFT</span><span class="o">(</span><span class="n">streamingSFT</span><span class="o">,</span> <span class="n">replayConfig</span><span class="o">);</span>
</pre></div>
</div>
<p>The <tt class="docutils literal"><span class="pre">streamingSFT</span></tt> passed to <tt class="docutils literal"><span class="pre">createReplaySFT</span></tt> must contain the
hints added by <tt class="docutils literal"><span class="pre">KafkaDataStoreHelper.createStreamingSFT</span></tt>. The easiest
way to ensure this is to call <tt class="docutils literal"><span class="pre">consumerDs.getSchema(typeName)</span></tt>. The
<tt class="docutils literal"><span class="pre">SimpleFeatureType</span></tt> returned by <tt class="docutils literal"><span class="pre">createReplaySFT</span></tt> will contain the
hint added by <tt class="docutils literal"><span class="pre">createStreamingSFT</span></tt> as well as a a hint containing the
<tt class="docutils literal"><span class="pre">ReplayConfig</span></tt>. Additionally the <tt class="docutils literal"><span class="pre">replaySFT</span></tt> will have a different
name than <tt class="docutils literal"><span class="pre">streamingSFT</span></tt>. This is to differentiate <em>live</em> and
<em>replay</em> <tt class="docutils literal"><span class="pre">SimpleFeatureType</span></tt>s. The <tt class="docutils literal"><span class="pre">replaySFT</span></tt> will also contain
an additional attribute, <tt class="docutils literal"><span class="pre">KafkaLogTime</span></tt>, of type <tt class="docutils literal"><span class="pre">java.util.Date</span></tt>
which represents the historical query time.</p>
<p>After creating the <tt class="docutils literal"><span class="pre">replaySFT</span></tt> the Kafka Replay Feature Source may be
created:</p>
<div class="highlight-java"><div class="highlight"><pre><span class="n">consumerDs</span><span class="o">.</span><span class="na">createSchema</span><span class="o">(</span><span class="n">replaySFT</span><span class="o">);</span>

<span class="n">String</span> <span class="n">replayTimeName</span> <span class="o">=</span> <span class="n">replaySFT</span><span class="o">.</span><span class="na">getTypeName</span><span class="o">();</span>
<span class="n">SimpleFeatureSource</span> <span class="n">replayFeatureSource</span> <span class="o">=</span> <span class="n">consumerDs</span><span class="o">.</span><span class="na">getFeatureSource</span><span class="o">(</span><span class="n">replayTimeName</span><span class="o">);</span>
</pre></div>
</div>
<p>The call to <tt class="docutils literal"><span class="pre">createSchema</span></tt> is required because the <tt class="docutils literal"><span class="pre">replaySFT</span></tt> is a
new <tt class="docutils literal"><span class="pre">SimpleFeatureType</span></tt>.</p>
<p>Finally the Kafka Replay Consumer Feature Source can be queried:</p>
<div class="highlight-java"><div class="highlight"><pre><span class="n">Instant</span> <span class="n">historicalTime</span> <span class="o">=</span> <span class="o">...</span>
<span class="n">Filter</span> <span class="n">timeFilter</span> <span class="o">=</span> <span class="n">ff</span><span class="o">.</span><span class="na">and</span><span class="o">(</span><span class="n">filter</span><span class="o">,</span> <span class="n">ReplayTimeHelper</span><span class="o">.</span><span class="na">toFilter</span><span class="o">(</span><span class="n">historicalTime</span><span class="o">));</span>

<span class="n">replayFeatureSource</span><span class="o">.</span><span class="na">getFeatures</span><span class="o">(</span><span class="n">timeFilter</span><span class="o">);</span>
</pre></div>
</div>
</div>
</div>


           </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2013-2017 Commonwealth Computer Research, Inc.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'1.3.2-SNAPSHOT',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>
      <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
      <script type="text/javascript" src="../../_static/sphinx_tabs/tabs.js"></script>
      <script type="text/javascript" src="../../_static/sphinx_tabs/semantic-ui-2.2.7/tab.min.js"></script>

  

  
  
    <script type="text/javascript" src="../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>