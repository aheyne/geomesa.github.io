

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>SparkSQL &mdash; GeoMesa 1.3.2-SNAPSHOT Manuals</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../_static/css/theme_custom.css" type="text/css" />
  

  

  
    <link rel="top" title="GeoMesa 1.3.2-SNAPSHOT Manuals" href="../../index.html"/> 

  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../index.html" class="icon icon-home"> GeoMesa
          

          
          </a>

          
            
            
              <div class="version">
                1.3.2-SNAPSHOT
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul>
<li class="toctree-l1"><a class="reference internal" href="../index.html">User Manual</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../developer/index.html">Developer Manual</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tutorials/index.html">Tutorials</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../index.html">GeoMesa</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          





<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../index.html">Docs</a> &raquo;</li>
      
    <li>SparkSQL</li>
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../../_sources/user/spark/sparksql.txt" rel="nofollow"> View page source</a>
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="sparksql">
<h1>SparkSQL<a class="headerlink" href="#sparksql" title="Permalink to this headline">¶</a></h1>
<p>GeoMesa SparkSQL support builds upon the <tt class="docutils literal"><span class="pre">DataSet</span></tt>/<tt class="docutils literal"><span class="pre">DataFrame</span></tt> API present
in the Spark SQL module to provide geospatial capabilities. This includes
custom geospatial data types and functions, the ability to create a <tt class="docutils literal"><span class="pre">DataFrame</span></tt>
from a GeoTools <tt class="docutils literal"><span class="pre">DataStore</span></tt>, and optimizations to improve SQL query performance.</p>
<p>GeoMesa SparkSQL code is provided by the <tt class="docutils literal"><span class="pre">geomesa-spark-sql</span></tt> module:</p>
<div class="highlight-xml"><div class="highlight"><pre><span class="nt">&lt;dependency&gt;</span>
  <span class="nt">&lt;groupId&gt;</span>org.locationtech.geomesa<span class="nt">&lt;/groupId&gt;</span>
  <span class="nt">&lt;artifactId&gt;</span>geomesa-spark-sql_2.11<span class="nt">&lt;/artifactId&gt;</span>
  // version, etc.
<span class="nt">&lt;/dependency&gt;</span>
</pre></div>
</div>
<div class="section" id="example">
<h2>Example<a class="headerlink" href="#example" title="Permalink to this headline">¶</a></h2>
<p>The following is a Scala example of connecting to GeoMesa Accumulo
via SparkSQL:</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="c1">// DataStore params to a hypothetical GeoMesa Accumulo table</span>
<span class="k">val</span> <span class="n">dsParams</span> <span class="k">=</span> <span class="nc">Map</span><span class="o">(</span>
  <span class="s">&quot;instanceId&quot;</span> <span class="o">-&gt;</span> <span class="s">&quot;instance&quot;</span><span class="o">,</span>
  <span class="s">&quot;zookeepers&quot;</span> <span class="o">-&gt;</span> <span class="s">&quot;zoo1,zoo2,zoo3&quot;</span><span class="o">,</span>
  <span class="s">&quot;user&quot;</span>       <span class="o">-&gt;</span> <span class="s">&quot;user&quot;</span><span class="o">,</span>
  <span class="s">&quot;password&quot;</span>   <span class="o">-&gt;</span> <span class="s">&quot;*****&quot;</span><span class="o">,</span>
  <span class="s">&quot;auths&quot;</span>      <span class="o">-&gt;</span> <span class="s">&quot;USER,ADMIN&quot;</span><span class="o">,</span>
  <span class="s">&quot;tableName&quot;</span>  <span class="o">-&gt;</span> <span class="s">&quot;geomesa_catalog&quot;</span><span class="o">)</span>

<span class="c1">// Create SparkSession</span>
<span class="k">val</span> <span class="n">sparkSession</span> <span class="k">=</span> <span class="nc">SparkSession</span><span class="o">.</span><span class="n">builder</span><span class="o">()</span>
  <span class="o">.</span><span class="n">appName</span><span class="o">(</span><span class="s">&quot;testSpark&quot;</span><span class="o">)</span>
  <span class="o">.</span><span class="n">config</span><span class="o">(</span><span class="s">&quot;spark.sql.crossJoin.enabled&quot;</span><span class="o">,</span> <span class="s">&quot;true&quot;</span><span class="o">)</span>
  <span class="o">.</span><span class="n">master</span><span class="o">(</span><span class="s">&quot;local[*]&quot;</span><span class="o">)</span>
  <span class="o">.</span><span class="n">getOrCreate</span><span class="o">()</span>

<span class="c1">// Create DataFrame using the &quot;geomesa&quot; format</span>
<span class="k">val</span> <span class="n">dataFrame</span> <span class="k">=</span> <span class="n">sparkSession</span><span class="o">.</span><span class="n">read</span>
  <span class="o">.</span><span class="n">format</span><span class="o">(</span><span class="s">&quot;geomesa&quot;</span><span class="o">)</span>
  <span class="o">.</span><span class="n">options</span><span class="o">(</span><span class="n">dsParams</span><span class="o">)</span>
  <span class="o">.</span><span class="n">option</span><span class="o">(</span><span class="s">&quot;geomesa.feature&quot;</span><span class="o">,</span> <span class="s">&quot;chicago&quot;</span><span class="o">)</span>
  <span class="o">.</span><span class="n">load</span><span class="o">()</span>
<span class="n">dataFrame</span><span class="o">.</span><span class="n">createOrReplaceTempView</span><span class="o">(</span><span class="s">&quot;chicago&quot;</span><span class="o">)</span>

<span class="c1">// Query against the &quot;chicago&quot; schema</span>
<span class="k">val</span> <span class="n">sqlQuery</span> <span class="k">=</span> <span class="s">&quot;select * from chicago where st_contains(st_makeBBOX(0.0, 0.0, 90.0, 90.0), geom)&quot;</span>
<span class="k">val</span> <span class="n">resultDataFrame</span> <span class="k">=</span> <span class="n">sparkSession</span><span class="o">.</span><span class="n">sql</span><span class="o">(</span><span class="n">sqlQuery</span><span class="o">)</span>

<span class="n">resultDataFrame</span><span class="o">.</span><span class="n">show</span>
<span class="cm">/*</span>
<span class="cm">+-------+------+-----------+--------------------+-----------------+</span>
<span class="cm">|__fid__|arrest|case_number|                 dtg|             geom|</span>
<span class="cm">+-------+------+-----------+--------------------+-----------------+</span>
<span class="cm">|      4|  true|          4|2016-01-04 00:00:...|POINT (76.5 38.5)|</span>
<span class="cm">|      5|  true|          5|2016-01-05 00:00:...|    POINT (77 38)|</span>
<span class="cm">|      6|  true|          6|2016-01-06 00:00:...|    POINT (78 39)|</span>
<span class="cm">|      7|  true|          7|2016-01-07 00:00:...|    POINT (20 20)|</span>
<span class="cm">|      9|  true|          9|2016-01-09 00:00:...|    POINT (50 50)|</span>
<span class="cm">+-------+------+-----------+--------------------+-----------------+</span>
<span class="cm">*/</span>
</pre></div>
</div>
</div>
<div class="section" id="configuration">
<h2>Configuration<a class="headerlink" href="#configuration" title="Permalink to this headline">¶</a></h2>
<p>Because GeoMesa SparkSQL stacks on top of the <tt class="docutils literal"><span class="pre">geomesa-spark-core</span></tt> module,
one or more of the <tt class="docutils literal"><span class="pre">SpatialRDDProvider</span></tt> implementations, as described in
<a class="reference internal" href="core.html"><em>Spark Core</em></a>, must be included on the classpath. The shaded JAR built by the
<strong>geomesa-accumulo-spark-runtime</strong> module (<tt class="docutils literal"><span class="pre">geomesa-accumulo/geomesa-accumulo-spark-runtime</span></tt>
in the source distribution) contains all of the dependencies needed to run
the <a class="reference internal" href="core.html#accumulo-rdd-provider"><em>Accumulo RDD Provider</em></a> as well as <strong>geomesa-spark-sql</strong>. This shaded
JAR can be passed (for example) to the <tt class="docutils literal"><span class="pre">spark-submit</span></tt> command via the <tt class="docutils literal"><span class="pre">--jars</span></tt>
option:</p>
<div class="highlight-bash"><div class="highlight"><pre>--jars file://path/to/geomesa-accumulo-spark-runtime_2.11-<span class="nv">$VERSION</span>.jar
</pre></div>
</div>
<p>or passed to Spark via the appropriate mechanism in notebook servers such as
Jupyter (see <a class="reference internal" href="jupyter.html"><em>Deploying GeoMesa Spark with Jupyter Notebook</em></a>) or Zeppelin.</p>
<p>This shaded JAR should also provide the dependencies needed for the
<a class="reference internal" href="core.html#converter-rdd-provider"><em>Converter RDD Provider</em></a> and <a class="reference internal" href="core.html#geotools-rdd-provider"><em>GeoTools RDD Provider</em></a>, so these JARs
may simply be added to <tt class="docutils literal"><span class="pre">--jars</span></tt> as well (though in the latter
case additional JARs may be needed to implement the GeoTools data store accessed).</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">When using the <a class="reference internal" href="core.html#accumulo-rdd-provider"><em>Accumulo RDD Provider</em></a> or <a class="reference internal" href="core.html#converter-rdd-provider"><em>Converter RDD Provider</em></a>
with <strong>geomesa-spark-sql</strong>, it is not necessary to set up the Kryo serialization
described in <a class="reference internal" href="core.html#spark-sf-serialization"><em>Simple Feature Serialization</em></a>. However, this may be required when
using the <a class="reference internal" href="core.html#geotools-rdd-provider"><em>GeoTools RDD Provider</em></a>.</p>
</div>
<p>If you will be <tt class="docutils literal"><span class="pre">JOIN</span></tt>-ing multiple <tt class="docutils literal"><span class="pre">DataFrame</span></tt>s together, it will be necessary
to add the <tt class="docutils literal"><span class="pre">spark.sql.crossJoin.enabled</span></tt> property when creating the
<tt class="docutils literal"><span class="pre">SparkSession</span></tt> object:</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="k">val</span> <span class="n">spark</span> <span class="k">=</span> <span class="nc">SparkSession</span><span class="o">.</span><span class="n">builder</span><span class="o">().</span>
   <span class="c1">// ...</span>
   <span class="n">config</span><span class="o">(</span><span class="s">&quot;spark.sql.crossJoin.enabled&quot;</span><span class="o">,</span> <span class="s">&quot;true&quot;</span><span class="o">).</span>
   <span class="c1">// ...</span>
   <span class="n">getOrCreate</span><span class="o">()</span>
</pre></div>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">Cross-joins can be very, very inefficient. Take care to ensure that one or both
sets of data joined are very small, and consider using the <tt class="docutils literal"><span class="pre">broadcast()</span></tt> method
to ensure that at least one <tt class="docutils literal"><span class="pre">DataFrame</span></tt> joined is in memory.</p>
</div>
</div>
<div class="section" id="usage">
<h2>Usage<a class="headerlink" href="#usage" title="Permalink to this headline">¶</a></h2>
<p>To create a GeoMesa SparkSQL-enabled <tt class="docutils literal"><span class="pre">DataFrame</span></tt> with data corresponding to a particular
feature type, do the following:</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="c1">// dsParams contains the parameters to pass to the data store</span>
<span class="k">val</span> <span class="n">dataFrame</span> <span class="k">=</span> <span class="n">sparkSession</span><span class="o">.</span><span class="n">read</span>
  <span class="o">.</span><span class="n">format</span><span class="o">(</span><span class="s">&quot;geomesa&quot;</span><span class="o">)</span>
  <span class="o">.</span><span class="n">options</span><span class="o">(</span><span class="n">dsParams</span><span class="o">)</span>
  <span class="o">.</span><span class="n">option</span><span class="o">(</span><span class="s">&quot;geomesa.feature&quot;</span><span class="o">,</span> <span class="n">typeName</span><span class="o">)</span>
  <span class="o">.</span><span class="n">load</span><span class="o">()</span>
</pre></div>
</div>
<p>Specifically, invoking <tt class="docutils literal"><span class="pre">format(&quot;geomesa&quot;)</span></tt> registers the GeoMesa SparkSQL data source, and
<tt class="docutils literal"><span class="pre">option(&quot;geomesa.feature&quot;,</span> <span class="pre">typeName)</span></tt> tells GeoMesa to use the feature type
named  <tt class="docutils literal"><span class="pre">typeName</span></tt>. This also registers the custom user-defined types and functions
implemented in GeoMesa SparkSQL.</p>
<p>By registering a <tt class="docutils literal"><span class="pre">DataFrame</span></tt> as a temporary view, it is possible to access
this data frame in subsequent SQL calls. For example:</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="n">dataFrame</span><span class="o">.</span><span class="n">createOrReplaceTempView</span><span class="o">(</span><span class="s">&quot;chicago&quot;</span><span class="o">)</span>
</pre></div>
</div>
<p>makes it possible to call this data frame via the alias &#8220;chicago&#8221;:</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="k">val</span> <span class="n">sqlQuery</span> <span class="k">=</span> <span class="s">&quot;select * from chicago where st_contains(st_makeBBOX(0.0, 0.0, 90.0, 90.0), geom)&quot;</span>
<span class="k">val</span> <span class="n">resultDataFrame</span> <span class="k">=</span> <span class="n">sparkSession</span><span class="o">.</span><span class="n">sql</span><span class="o">(</span><span class="n">sqlQuery</span><span class="o">)</span>
</pre></div>
</div>
<p>Registering user-defined types and functions can also be done manually by invoking
<tt class="docutils literal"><span class="pre">SQLTypes.init()</span></tt> on the <tt class="docutils literal"><span class="pre">SQLContext</span></tt> object of the Spark session:</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="nc">SQLTypes</span><span class="o">.</span><span class="n">init</span><span class="o">(</span><span class="n">sparkSession</span><span class="o">.</span><span class="n">sqlContext</span><span class="o">)</span>
</pre></div>
</div>
</div>
<div class="section" id="geospatial-user-defined-types-and-functions">
<h2>Geospatial User-defined Types and Functions<a class="headerlink" href="#geospatial-user-defined-types-and-functions" title="Permalink to this headline">¶</a></h2>
<p>The GeoMesa SparkSQL module takes several <a class="reference external" href="http://docs.geotools.org/stable/userguide/library/jts/geometry.html">classes representing geometry objects</a>
(as described by the OGC <a class="reference external" href="http://www.opengeospatial.org/standards/sfa">OpenGIS Simple feature access common architecture</a> specification and
implemented by the Java Topology Suite) and registers them as user-defined types (UDTs) in
SparkSQL. These types are:</p>
<blockquote>
<div><ul class="simple">
<li><tt class="docutils literal"><span class="pre">Geometry</span></tt></li>
<li><tt class="docutils literal"><span class="pre">Point</span></tt></li>
<li><tt class="docutils literal"><span class="pre">LineString</span></tt></li>
<li><tt class="docutils literal"><span class="pre">Polygon</span></tt></li>
<li><tt class="docutils literal"><span class="pre">MultiPoint</span></tt></li>
<li><tt class="docutils literal"><span class="pre">MultiLineString</span></tt></li>
<li><tt class="docutils literal"><span class="pre">MultiPolygon</span></tt></li>
<li><tt class="docutils literal"><span class="pre">GeometryCollection</span></tt></li>
</ul>
</div></blockquote>
<p>GeoMesa SparkSQL also implements a subset of the functions described in the
OGC <a class="reference external" href="http://www.opengeospatial.org/standards/sfs">OpenGIS Simple feature access SQL option</a> specification as SparkSQL
user-defined functions (UDFs). These include functions
for creating geometries, accessing properties of geometries, casting
Geometry objects to more specific subclasses, outputting geometries in other
formats, measuring spatial relationships between geometries, and processing
geometries.</p>
<p>For example, the following SQL query</p>
<div class="code highlight-python"><div class="highlight"><pre>select * from chicago where st_contains(st_makeBBOX(0.0, 0.0, 90.0, 90.0), geom)
</pre></div>
</div>
<p>uses two UDFs&#8211;<tt class="docutils literal"><span class="pre">st_contains</span></tt> and <tt class="docutils literal"><span class="pre">st_makeBBOX</span></tt>&#8211;to find the rows in the <tt class="docutils literal"><span class="pre">chicago</span></tt>
<tt class="docutils literal"><span class="pre">DataFrame</span></tt> where column <tt class="docutils literal"><span class="pre">geom</span></tt> is contained within the specified bounding box.</p>
<p>A complete list of the implemented UDFs is given in the next section (<a class="reference internal" href="sparksql_functions.html"><em>SparkSQL Functions</em></a>).</p>
</div>
</div>


           </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2013-2016 Commonwealth Computer Research, Inc.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'1.3.2-SNAPSHOT',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>
      <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>