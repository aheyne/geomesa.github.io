<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>GeoMesa Authorizations &mdash; GeoMesa 1.2.0 Manuals</title>
    
    <link rel="stylesheet" href="../_static/sphinxdoc.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '1.2.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="top" title="GeoMesa 1.2.0 Manuals" href="../index.html" />
    <link rel="up" title="GeoMesa 1.2.0 Tutorials" href="index.html" />
    <link rel="next" title="Feature Level Visibility &amp; Security" href="geomesa-feature-level-visibility.html" />
    <link rel="prev" title="Web Processing Services (WPS) Tube Select" href="geomesa-tubeselect.html" /> 
  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="geomesa-feature-level-visibility.html" title="Feature Level Visibility &amp; Security"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="geomesa-tubeselect.html" title="Web Processing Services (WPS) Tube Select"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">GeoMesa 1.2.0 Manuals</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="index.html" accesskey="U">GeoMesa 1.2.0 Tutorials</a> &raquo;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">GeoMesa Authorizations</a><ul>
<li><a class="reference internal" href="#background">Background</a><ul>
<li><a class="reference internal" href="#visibilities-and-authorizations">Visibilities and Authorizations</a></li>
<li><a class="reference internal" href="#public-key-infrastructure-pki">Public Key Infrastructure (PKI)</a></li>
</ul>
</li>
<li><a class="reference internal" href="#prerequisites">Prerequisites</a></li>
<li><a class="reference internal" href="#visibilities-in-geomesa">Visibilities in GeoMesa</a></li>
<li><a class="reference internal" href="#authorizations-in-geomesa">Authorizations In GeoMesa</a></li>
<li><a class="reference internal" href="#ingest-gdelt-data-with-visibilities">Ingest GDELT Data with Visibilities</a></li>
<li><a class="reference internal" href="#download-and-build-the-tutorial-code">Download and Build the Tutorial Code</a></li>
<li><a class="reference internal" href="#run-the-tutorial">Run the Tutorial</a></li>
<li><a class="reference internal" href="#looking-closer-at-the-code">Looking Closer at the Code</a></li>
<li><a class="reference internal" href="#applying-authorizations-and-visibilities-to-geoserver-using-pkis-and-ldap">Applying Authorizations and Visibilities to GeoServer Using PKIs And LDAP</a><ul>
<li><a class="reference internal" href="#run-geoserver-in-tomcat">Run GeoServer in Tomcat</a></li>
<li><a class="reference internal" href="#create-the-accumulo-data-store-and-layer-in-geoserver">Create the Accumulo Data Store and Layer in GeoServer</a></li>
<li><a class="reference internal" href="#configure-geoserver-for-pki-login">Configure GeoServer for PKI Login</a></li>
<li><a class="reference internal" href="#install-an-ldap-server-for-storing-authorizations">Install an LDAP Server for Storing Authorizations</a></li>
<li><a class="reference internal" href="#configure-ldap-for-storing-authorizations">Configure LDAP for Storing Authorizations</a></li>
<li><a class="reference internal" href="#test-ldap-connection-using-tutorial-code">Test LDAP Connection Using Tutorial Code</a></li>
<li><a class="reference internal" href="#installing-the-ldap-authorizationprovider-in-geoserver">Installing the LDAP AuthorizationProvider in GeoServer</a></li>
<li><a class="reference internal" href="#verifying-the-ldap-authorizations-in-geoserver">Verifying the LDAP Authorizations in GeoServer</a></li>
</ul>
</li>
<li><a class="reference internal" href="#querying-geoserver-through-a-web-feature-service-wfs-with-a-java-client">Querying GeoServer through a Web Feature Service (WFS) with a Java Client</a></li>
<li><a class="reference internal" href="#id1">Looking Closer at the Code</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="geomesa-tubeselect.html"
                        title="previous chapter">Web Processing Services (WPS) Tube Select</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="geomesa-feature-level-visibility.html"
                        title="next chapter">Feature Level Visibility &amp; Security</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/tutorials/geomesa-authorizations.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="geomesa-authorizations">
<h1>GeoMesa Authorizations<a class="headerlink" href="#geomesa-authorizations" title="Permalink to this headline">¶</a></h1>
<p>This tutorial will show you how to:</p>
<ol class="arabic simple">
<li>Set visibilities on your data during ingestion through GeoMesa.</li>
<li>Apply authorizations to your queries through GeoMesa.</li>
<li>Implement user authorizations through the GeoMesa GeoServer plugin,
using PKI certs to authenticate with GeoServer and LDAP to store
authorizations.</li>
<li>Query GeoServer over WFS using a Java client using PKI certs for
authentication.</li>
</ol>
<div class="section" id="background">
<h2>Background<a class="headerlink" href="#background" title="Permalink to this headline">¶</a></h2>
<div class="section" id="visibilities-and-authorizations">
<h3>Visibilities and Authorizations<a class="headerlink" href="#visibilities-and-authorizations" title="Permalink to this headline">¶</a></h3>
<p>One of the most powerful features of Accumulo is the implementation of
cell-level security, using <strong>visibilities</strong> and <strong>authorizations</strong>.
Data that is protected by visibilities can only be seen by users that
have the corresponding authorizations. This allows for the fine-grained
protection of data, based on arbitrary labels.</p>
<p><em>Note: authorizations are distinct from table-level permissions, and
operate at a much finer grain.</em></p>
<p>If you are not familiar with Accumulo authorizations, you should review
the relevant Accumulo
<a class="reference external" href="http://accumulo.apache.org/1.5/accumulo_user_manual.html#_security">documentation</a>,
with more examples
<a class="reference external" href="http://accumulo.apache.org/1.5/examples/visibility.html">here</a>.</p>
</div>
<div class="section" id="public-key-infrastructure-pki">
<h3>Public Key Infrastructure (PKI)<a class="headerlink" href="#public-key-infrastructure-pki" title="Permalink to this headline">¶</a></h3>
<p>Public key infrastructure can be used to securely authenticate end
users. In PKI, a <strong>certificate authority</strong> (CA) will issue digital
certificates that verify that a particular public key belongs to a
particular individual. Other users can then trust that certificate
because it has been digitally signed by the CA.</p>
<p>In this tutorial, the keys used are not provided by trusted CAs. As
such, it is necessary to import the CA&#8217;s certificate into the Java
keystore, which allows Java (and by extension Tomcat) to trust any keys
verified by the CA.</p>
<p>PKI solves the issue of <strong>authentication</strong> (<em>who</em> a user is) but not
<strong>authorization</strong> (<em>what</em> a user can do). For this tutorial,
authorization is provided by an LDAP server.</p>
</div>
</div>
<div class="section" id="prerequisites">
<h2>Prerequisites<a class="headerlink" href="#prerequisites" title="Permalink to this headline">¶</a></h2>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">You will need access to a Hadoop 2.2 installation as well as an Accumulo 1.5 or 1.6 database.</p>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">You will need to have ingested GDELT data using GeoMesa. Instructions are
available in the <a class="reference internal" href="geomesa-gdelt-analysis.html"><em>Map-Reduce Ingest</em></a> tutorial.</p>
</div>
<p>You will also need:</p>
<ul class="simple">
<li>an Accumulo user that has appropriate permissions to query your data,</li>
<li>Java JDK 7,</li>
<li><a class="reference external" href="http://maven.apache.org/">Apache Maven</a> 3.2.2 or better, and</li>
<li>a <a class="reference external" href="http://git-scm.com/">git</a> client.</li>
</ul>
</div>
<div class="section" id="visibilities-in-geomesa">
<h2>Visibilities in GeoMesa<a class="headerlink" href="#visibilities-in-geomesa" title="Permalink to this headline">¶</a></h2>
<p>Currently GeoMesa supports applying a single set of visibilities to all
data in a <code class="docutils literal"><span class="pre">DataStore</span></code>. When configuring a <code class="docutils literal"><span class="pre">DataStore</span></code>, the
visibilities can be set with the <code class="docutils literal"><span class="pre">visibilities</span></code> parameter:</p>
<div class="highlight-java"><div class="highlight"><pre><span class="c1">// create a map containing initialization data for the GeoMesa data store</span>
<span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">configuration</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;();</span>
<span class="n">configuration</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;visibilities&quot;</span><span class="o">,</span> <span class="s">&quot;user&amp;admin&quot;</span><span class="o">);</span>
<span class="n">DataStore</span> <span class="n">dataStore</span> <span class="o">=</span> <span class="n">DataStoreFinder</span><span class="o">.</span><span class="na">getDataStore</span><span class="o">(</span><span class="n">configuration</span><span class="o">);</span>
</pre></div>
</div>
<p>Any data written by this <code class="docutils literal"><span class="pre">DataStore</span></code> will have the visibilities
&#8220;user&amp;admin&#8221; applied.</p>
<p>Future versions of GeoMesa will allow visibilities to be applied at a
more granular level.</p>
</div>
<div class="section" id="authorizations-in-geomesa">
<h2>Authorizations In GeoMesa<a class="headerlink" href="#authorizations-in-geomesa" title="Permalink to this headline">¶</a></h2>
<p>When performing a query, GeoMesa delegates the retrieval of
authorizations to <strong>service providers</strong> that implement the following
interface:</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="nn">geomesa.core.security</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">AuthorizationsProvider</span> <span class="o">{</span>

    <span class="cm">/**</span>
<span class="cm">     * Gets the authorizations for the current context. This may change over time (e.g. in a</span>
<span class="cm">     * multi-user environment), so the result should not be cached.</span>
<span class="cm">     *</span>
<span class="cm">     * @return</span>
<span class="cm">     */</span>
    <span class="kd">public</span> <span class="n">Authorizations</span> <span class="nf">getAuthorizations</span><span class="o">();</span>

    <span class="cm">/**</span>
<span class="cm">     * Configures this instance with parameters passed into the DataStoreFinder</span>
<span class="cm">     *</span>
<span class="cm">     * @param params</span>
<span class="cm">     */</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">(</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Serializable</span><span class="o">&gt;</span> <span class="n">params</span><span class="o">);</span>
<span class="o">}</span>
</pre></div>
</div>
<p>When a GeoMesa <code class="docutils literal"><span class="pre">DataStore</span></code> is instantiated, it will scan for available
service providers. Third-party implementations can be enabled by simply
placing them in the classpath. See the Oracle
<a class="reference external" href="http://docs.oracle.com/javase/7/docs/api/javax/imageio/spi/ServiceRegistry.html">Javadoc</a>
for details on implementing a service provider.</p>
<p>The GeoMesa <code class="docutils literal"><span class="pre">DataStore</span></code> will call <code class="docutils literal"><span class="pre">configure()</span></code> on the
<code class="docutils literal"><span class="pre">AuthorizationsProvider</span></code> implementation, passing in the parameter map
from the call to <code class="docutils literal"><span class="pre">DataStoreFinder.getDataStore(Map</span> <span class="pre">params)</span></code>. This
allows the AuthorizationsProvider to configure itself based on the
environment.</p>
<p>To ensure that the correct <code class="docutils literal"><span class="pre">AuthorizationsProvider</span></code> is used, GeoMesa
will throw an exception if multiple third-party service providers are
found on the classpath. In this scenario, the particular service
provider class to use can be specified by the following system property:</p>
<div class="highlight-java"><div class="highlight"><pre><span class="n">geomesa</span><span class="o">.</span><span class="na">core</span><span class="o">.</span><span class="na">security</span><span class="o">.</span><span class="na">AuthorizationsProvider</span><span class="o">.</span><span class="na">AUTH_PROVIDER_SYS_PROPERTY</span> <span class="o">=</span> <span class="s">&quot;geomesa.auth.provider.impl&quot;</span><span class="o">;</span>
</pre></div>
</div>
<p>For simple scenarios, the set of authorizations to apply to all queries
can be specified when creating the GeoMesa <code class="docutils literal"><span class="pre">DataStore</span></code> by using the
<code class="docutils literal"><span class="pre">auths</span></code> configuration parameter. This will use the
<code class="docutils literal"><span class="pre">DefaultAuthorizationsProvider</span></code> implementation provided by GeoMesa.</p>
<div class="highlight-java"><div class="highlight"><pre><span class="c1">// create a map containing initialization data for the GeoMesa data store</span>
<span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">configuration</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;();</span>
<span class="n">configuration</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;auths&quot;</span><span class="o">,</span> <span class="s">&quot;user,admin&quot;</span><span class="o">);</span>
<span class="n">DataStore</span> <span class="n">dataStore</span> <span class="o">=</span> <span class="n">DataStoreFinder</span><span class="o">.</span><span class="na">getDataStore</span><span class="o">(</span><span class="n">configuration</span><span class="o">);</span>
</pre></div>
</div>
<p>If there are no <code class="docutils literal"><span class="pre">AuthorizationsProvider</span></code>s found on the classpath,
and the <code class="docutils literal"><span class="pre">auths</span></code> parameter is not set, GeoMesa will default to using
the authorizations associated with the Accumulo connection (i.e. the
<code class="docutils literal"><span class="pre">user</span></code> configuration value).</p>
<p><strong>Note: this is not a recommended approach for a production system.</strong></p>
<p>In addition, please note that the authorizations used in any scenario
cannot exceed the authorizations of the Accumulo connection.</p>
</div>
<div class="section" id="ingest-gdelt-data-with-visibilities">
<h2>Ingest GDELT Data with Visibilities<a class="headerlink" href="#ingest-gdelt-data-with-visibilities" title="Permalink to this headline">¶</a></h2>
<p>The rest of this tutorial will use the GDELT data set, described in the
<a class="reference external" href="/geomesa-gdelt-analysis/">GDELT Map-Reduce tutorial</a>. If you have
never ingested GDELT data, or you have previously ingested it
<strong>without</strong> visibilities, you will need to ingest it again.</p>
<p>Follow the instructions <a class="reference external" href="/geomesa-gdelt-analysis/">here</a>, with the
following changes:</p>
<ul class="simple">
<li>Ensure that you have the latest version of the GeoMesa tutorial code
from GitHub.</li>
<li>When executing the map/reduce job, include the following parameter:</li>
</ul>
<div class="highlight-bash"><div class="highlight"><pre>-visibilities &lt;visibilities&gt;
</pre></div>
</div>
<p>The entire command will be as follows:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>hadoop jar /path/to/geomesa-examples-gdelt-<span class="nv">$VERSION</span>.jar <span class="se">\</span>
   com.example.geomesa.gdelt.GDELTIngest                         <span class="se">\</span>
   -instanceId &lt;accumulo-instance-id&gt;                <span class="se">\</span>
   -zookeepers &lt;zookeeper-hosts-string&gt;              <span class="se">\</span>
   -user &lt;username&gt; -password &lt;password&gt;             <span class="se">\</span>
   -visibilities &lt;visibilities&gt;                      <span class="se">\</span>
   -tableName &lt;table&gt; -featureName &lt;feature&gt;         <span class="se">\</span>
   -ingestFile hdfs:///gdelt/uncompressed/gdelt.tsv
</pre></div>
</div>
<p>The visibility string can be anything valid for your Accumulo instance.
For the rest of this exercise, we are going to assume the visibility
string is &#8220;user&#8221;, and the Accumulo table is &#8220;gdelt_auths&#8221;. You can see
the visibilities that are currently enabled for your user through the
<code class="docutils literal"><span class="pre">accumulo</span></code> shell:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>accumulo shell -u &lt;username&gt; -p &lt;password&gt;

Shell - Apache Accumulo Interactive Shell
-
- version: 1.5.1
- instance name: mycloud
- instance id: xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx
-
- <span class="nb">type</span> <span class="s1">&#39;help&#39;</span> <span class="k">for</span> a list of available commands
-
myuser@mycloud&gt; getauths
user,admin
</pre></div>
</div>
<p>If your user does not already have authorizations, you can add them
through the Accumulo shell with the <code class="docutils literal"><span class="pre">addauths</span></code> command:</p>
<p><strong>Note: A user cannot set authorizations unless the user has the
System.ALTER_USER permission.</strong></p>
<div class="highlight-bash"><div class="highlight"><pre>myuser@mycloud&gt; getauths
user
myuser@mycloud&gt; addauths -s admin -u myuser
myuser@mycloud&gt; getauths
user,admin
</pre></div>
</div>
<p>Once the GDELT data is ingested, you should see a visibility label in
square brackets when you scan the spatio-temporal index table through
the Accumulo shell:</p>
<div class="highlight-bash"><div class="highlight"><pre>myuser@mycloud&gt; table gdelt_auths_gdelt_st_idx
myuser@mycloud gdelt_auths_gdelt_st_idx&gt; scan
00~gdelt~04e~20080125 169881494:SimpleFeatureAttribute <span class="o">[</span>user<span class="o">]</span>    <span class="se">\x</span>02<span class="se">\x</span>12169881494<span class="se">\x</span>00<span class="se">\x</span>AC<span class="se">\x</span>BE...
</pre></div>
</div>
</div>
<div class="section" id="download-and-build-the-tutorial-code">
<h2>Download and Build the Tutorial Code<a class="headerlink" href="#download-and-build-the-tutorial-code" title="Permalink to this headline">¶</a></h2>
<p>Clone the tutorial code:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>git clone https://github.com/geomesa/geomesa-tutorials.git
</pre></div>
</div>
<p>The authorizations tutorial is located in the <code class="docutils literal"><span class="pre">geomesa-examples-authorizations</span></code>
directory:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span><span class="nb">cd </span>com.example.geomesa.authorizations./geomesa-examples-authorizations
</pre></div>
</div>
<p>The <code class="docutils literal"><span class="pre">pom.xml</span></code> file here contains an explicit list of dependent libraries
that will be bundled together into the final tutorial. You should
confirm that the versions of Accumulo and Hadoop match what you are
running; if it does not match, change the value in the POM.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The only reason these libraries are bundled into the final JAR is that this
is easier for most people to do this than it is to set the classpath
when running the tutorial. If you would rather not bundle these
dependencies, mark them as provided in the POM, and update your
classpath as appropriate.</p>
</div>
<p>From within this directory, run:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>mvn clean install
</pre></div>
</div>
<p>When this is complete, it will have built a JAR file that contains all
of the code you need to run the tutorial.</p>
</div>
<div class="section" id="run-the-tutorial">
<h2>Run the Tutorial<a class="headerlink" href="#run-the-tutorial" title="Permalink to this headline">¶</a></h2>
<p>On the command-line, run:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>java -cp ./target/geomesa-examples-authorizations-1.0-SNAPSHOT.jar <span class="se">\</span>
   com.example.geomesa.authorizations.AuthorizationsTutorial <span class="se">\</span>
   -instanceId &lt;instance&gt; <span class="se">\</span>
   -zookeepers &lt;zoos&gt; <span class="se">\</span>
   -user &lt;user&gt; <span class="se">\</span>
   -password &lt;<span class="nb">pwd</span>&gt; <span class="se">\</span>
   -visibilities &lt;visibilities&gt; <span class="se">\</span>
   -tableName &lt;table&gt; <span class="se">\</span>
   -featureName &lt;feature&gt;
</pre></div>
</div>
<p>where you provide the following arguments:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">&lt;instance&gt;</span></code>: the name of your Accumulo instance</li>
<li><code class="docutils literal"><span class="pre">&lt;zoos&gt;</span></code>: comma-separated list of your Zookeeper nodes, e.g.
<code class="docutils literal"><span class="pre">zoo1:2181,zoo2:2181,zoo3:2181</span></code></li>
<li><code class="docutils literal"><span class="pre">&lt;user&gt;</span></code>: the name of an Accumulo user that will execute the scans,
e.g. <code class="docutils literal"><span class="pre">root</span></code></li>
<li><code class="docutils literal"><span class="pre">&lt;pwd&gt;</span></code>: the password for the previously-mentioned Accumulo user</li>
<li><code class="docutils literal"><span class="pre">&lt;visibilities&gt;</span></code>: the visibilities used to ingest the GDELT
dataset, e.g. <code class="docutils literal"><span class="pre">user</span></code></li>
<li><code class="docutils literal"><span class="pre">&lt;table&gt;</span></code>: the name of the Accumulo table that has the GeoMesa
GDELT dataset, e.g. <code class="docutils literal"><span class="pre">gdelt_auths</span></code></li>
<li><code class="docutils literal"><span class="pre">&lt;feature&gt;</span></code>: the feature name used to ingest the GeoMesa GDELT
dataset, e.g. <code class="docutils literal"><span class="pre">gdelt</span></code></li>
</ul>
<p>You should see two queries run and the results printed out to your
console. You should see output similar to the following:</p>
<div class="highlight-bash"><div class="highlight"><pre>Executing query with AUTHORIZED data store: auths are <span class="s1">&#39;user,admin&#39;</span>
Results:
1<span class="p">|</span><span class="nv">geom</span><span class="o">=</span>POINT <span class="o">(</span>33.9744 45.2908<span class="o">)</span>

Executing query with UNAUTHORIZED data store: auths are <span class="s1">&#39;&#39;</span>
No results
</pre></div>
</div>
<p>The first query should return 1 or more results. The second query should
return 0 results, since they are hidden by visibilities.</p>
</div>
<div class="section" id="looking-closer-at-the-code">
<h2>Looking Closer at the Code<a class="headerlink" href="#looking-closer-at-the-code" title="Permalink to this headline">¶</a></h2>
<p>The code for querying with authorizations is available in the class
<code class="docutils literal"><span class="pre">AuthorizationsTutorial</span></code>.</p>
<p>The interesting code for this tutorial is contained in the <code class="docutils literal"><span class="pre">main</span></code>
method:</p>
<div class="highlight-java"><div class="highlight"><pre><span class="c1">// get an instance of the data store that uses the default authorizations provider, which</span>
<span class="c1">// will use whatever auths the connector has available</span>
<span class="n">System</span><span class="o">.</span><span class="na">setProperty</span><span class="o">(</span><span class="n">AuthorizationsProvider</span><span class="o">.</span><span class="na">AUTH_PROVIDER_SYS_PROPERTY</span><span class="o">,</span>
    <span class="n">DefaultAuthorizationsProvider</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>
<span class="n">DataStore</span> <span class="n">authDataStore</span> <span class="o">=</span> <span class="n">DataStoreFinder</span><span class="o">.</span><span class="na">getDataStore</span><span class="o">(</span><span class="n">dsConf</span><span class="o">);</span>

<span class="c1">// get another instance of the data store that uses our authorizations provider that</span>
<span class="c1">// always returns empty auths</span>
<span class="n">System</span><span class="o">.</span><span class="na">setProperty</span><span class="o">(</span><span class="n">AuthorizationsProvider</span><span class="o">.</span><span class="na">AUTH_PROVIDER_SYS_PROPERTY</span><span class="o">,</span>
    <span class="n">EmptyAuthorizationsProvider</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>
<span class="n">DataStore</span> <span class="n">noAuthDataStore</span> <span class="o">=</span> <span class="n">DataStoreFinder</span><span class="o">.</span><span class="na">getDataStore</span><span class="o">(</span><span class="n">dsConf</span><span class="o">);</span>
</pre></div>
</div>
<p>This code snippet shows how you can specify the
<code class="docutils literal"><span class="pre">AuthorizationProvider</span></code> to use with a system property. The
<code class="docutils literal"><span class="pre">DefaultAuthorizationsProvider</span></code> class is provided by GeoMesa, and used
when no other implementations are found. The
<code class="docutils literal"><span class="pre">EmptyAuthorizationsProvider</span></code> class is included in the tutorial:</p>
<div class="highlight-java"><div class="highlight"><pre><span class="n">com</span><span class="o">.</span><span class="na">example</span><span class="o">.</span><span class="na">geomesa</span><span class="o">.</span><span class="na">authorizations</span><span class="o">.</span><span class="na">EmptyAuthorizationsProvider</span>
</pre></div>
</div>
<p>The <code class="docutils literal"><span class="pre">EmptyAuthorizationsProvider</span></code> will always return an empty
<code class="docutils literal"><span class="pre">Authorizations</span></code> object, which means that any data stored with
visibilities will not be returned.</p>
<p>There is a more useful implementation of <code class="docutils literal"><span class="pre">AuthorizationsProvider</span></code> that
will be explored in more detail in the next section:</p>
<div class="highlight-java"><div class="highlight"><pre><span class="n">com</span><span class="o">.</span><span class="na">example</span><span class="o">.</span><span class="na">geomesa</span><span class="o">.</span><span class="na">authorizations</span><span class="o">.</span><span class="na">LdapAuthorizationsProvider</span>
<span class="n">com</span><span class="o">.</span><span class="na">example</span><span class="o">.</span><span class="na">geomesa</span><span class="o">.</span><span class="na">authorizations</span><span class="o">.</span><span class="na">LdapAuthorizationsProviderTest</span>
</pre></div>
</div>
<p>There is a class that shows how to query GeoServer through WFS that will
be explored in more detail later in the tutorial:</p>
<div class="highlight-java"><div class="highlight"><pre><span class="n">com</span><span class="o">.</span><span class="na">example</span><span class="o">.</span><span class="na">geomesa</span><span class="o">.</span><span class="na">authorizations</span><span class="o">.</span><span class="na">GeoServerAuthorizationsTutorial</span>
</pre></div>
</div>
<p>Additionally, there are two helper classes included in the tutorial:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">com.example.geomesa.authorizations.GdeltFeature</span></code> - Contains the attributes available
in the GDELT data set.</li>
<li><code class="docutils literal"><span class="pre">com.example.geomesa.authorizations.SetupUtil</span></code> - Handles reading command-line
arguments</li>
</ul>
</div>
<div class="section" id="applying-authorizations-and-visibilities-to-geoserver-using-pkis-and-ldap">
<h2>Applying Authorizations and Visibilities to GeoServer Using PKIs And LDAP<a class="headerlink" href="#applying-authorizations-and-visibilities-to-geoserver-using-pkis-and-ldap" title="Permalink to this headline">¶</a></h2>
<p>This section will show you how to configure GeoServer to authenticate
users with PKIs, use LDAP to store authorizations, then apply
authorizations on a per-user/per-query basis.</p>
<p>Basic user authentication will take place via user certificates. Each
user will have their own public/private key pair that uniquely
identifies them.</p>
<p>User authorizations will come from LDAP. Once a user&#8217;s identity has been
verified via PKI, we will look up the user&#8217;s details in LDAP.</p>
<p>Once we have a user&#8217;s authentication and authorizations, we will apply
them to the GeoMesa query using a custom <code class="docutils literal"><span class="pre">AuthorizationsProvider</span></code>
implementation.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">It is assumed for the rest of the tutorial that you have created
the GeoServer data stores and layers outlined in the GDELT
tutorial &lt;/geomesa-gdelt-analysis/&gt;</p>
</div>
<div class="section" id="run-geoserver-in-tomcat">
<h3>Run GeoServer in Tomcat<a class="headerlink" href="#run-geoserver-in-tomcat" title="Permalink to this headline">¶</a></h3>
<p><em>Note: If you are already running GeoServer in Tomcat, you can skip this
step.</em></p>
<p>GeoServer ships by default with an embedded Jetty servlet. In order to
use PKI login, we need to install it in Tomcat instead.</p>
<ol class="arabic simple">
<li>Download and install Tomcat 7.</li>
<li>Create an environment variable pointing to your Tomcat installation (you
may want to add this to your bash init scripts):</li>
</ol>
<div class="highlight-bash"><div class="highlight"><pre><span class="nb">export </span><span class="nv">CATALINA_HOME</span><span class="o">=</span>/path/to/tomcat
</pre></div>
</div>
<ol class="arabic simple" start="3">
<li>If you want to reuse your existing GeoServer configuration, create an
environment variable pointing to your GeoServer data directory (you may
want to add this to your shell initialization scripts):</li>
</ol>
<div class="highlight-bash"><div class="highlight"><pre><span class="nb">export </span><span class="nv">GEOSERVER_DATA_DIR</span><span class="o">=</span>/path/to/geoserver/data_dir
</pre></div>
</div>
<ol class="arabic simple" start="4">
<li>Copy the GeoServer webapp from the GeoServer distribution into the
tomcat servlet:</li>
</ol>
<div class="highlight-bash"><div class="highlight"><pre>cp -r /path/to/geoserver/webapps/geoserver/ <span class="nv">$CATALINA_HOME</span>/webapps/
</pre></div>
</div>
<ol class="arabic simple" start="5">
<li>Increase the memory allocated to Tomcat, which you will need for running
complex queries in GeoServer (the values here may not be applicable for
every installation):</li>
</ol>
<div class="highlight-bash"><div class="highlight"><pre><span class="nb">cd</span> <span class="nv">$CATALINA_HOME</span>/bin
<span class="nb">echo</span> <span class="s1">&#39;CATALINA_OPTS=&quot;-Xmx2g -XX:MaxPermSize=128m&quot;&#39;</span> &gt;&gt; setenv.sh
</pre></div>
</div>
<ol class="arabic simple" start="6">
<li>Start Tomcat, either as a service or through the startup scripts, and
ensure that GeoServer is available at <a class="reference external" href="http://localhost:8080/geoserver/web/">http://localhost:8080/geoserver/web/</a>.</li>
</ol>
</div>
<div class="section" id="create-the-accumulo-data-store-and-layer-in-geoserver">
<h3>Create the Accumulo Data Store and Layer in GeoServer<a class="headerlink" href="#create-the-accumulo-data-store-and-layer-in-geoserver" title="Permalink to this headline">¶</a></h3>
<p>If you haven&#8217;t already, create an AccumuloDataStore and associated Layer
pointing to the data with visibilities, as described in the <a class="reference external" href="/geomesa-gdelt-analysis/">GDELT
tutorial</a>.</p>
<p>When configuring the DataStore, leave the <strong>auths</strong> field empty and set
the <strong>visibilities</strong> field to what you used when ingesting data above.</p>
</div>
<div class="section" id="configure-geoserver-for-pki-login">
<h3>Configure GeoServer for PKI Login<a class="headerlink" href="#configure-geoserver-for-pki-login" title="Permalink to this headline">¶</a></h3>
<p>Follow the instructions located
<a class="reference external" href="http://docs.geoserver.org/stable/en/user/security/tutorials/cert/index.html">here</a>
in order to enable PKI login to GeoServer.</p>
<p>In the step where you add the &#8216;cert&#8217; filter to the &#8216;Filter Chains&#8217;, also
add it to the &#8216;rest&#8217;, &#8216;gwc&#8217; and &#8216;default&#8217; chains (in addition to web).
We will be using the &#8216;rod&#8217; and &#8216;scott&#8217; users, so be sure to install
those into your browser.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">There is a bug in some versions of GeoServer, where it sometimes
does not save authentication filters properly.</p>
</div>
<p>If, after going through the above steps, you do not get logged in
properly, do the following:</p>
<ol class="arabic simple">
<li>Shut down GeoServer.</li>
<li>Navigate to the GeoServer data directory: <code class="docutils literal"><span class="pre">$GEOSERVER_DATA_DIR</span></code>
or <code class="docutils literal"><span class="pre">$GEOSERVER_HOME/data_dir</span></code></li>
<li>Edit the file ./security/config.xml by adding the 4 lines below:</li>
</ol>
<div class="highlight-xml"><div class="highlight"><pre><span class="nt">&lt;filterChain&gt;</span>
  <span class="nt">&lt;filters</span> <span class="na">name=</span><span class="s">&quot;web&quot;</span> <span class="na">class=</span><span class="s">&quot;org.geoserver.security.HtmlLoginFilterChain&quot;</span> <span class="na">interceptorName=</span><span class="s">&quot;interceptor&quot;</span> <span class="na">exceptionTranslationName=</span><span class="s">&quot;exception&quot;</span> <span class="na">path=</span><span class="s">&quot;/web/**,/gwc/rest/web/**,/&quot;</span> <span class="na">disabled=</span><span class="s">&quot;false&quot;</span> <span class="na">allowSessionCreation=</span><span class="s">&quot;true&quot;</span> <span class="na">ssl=</span><span class="s">&quot;false&quot;</span> <span class="na">matchHTTPMethod=</span><span class="s">&quot;false&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;filter&gt;</span>rememberme<span class="nt">&lt;/filter&gt;</span>
    <span class="nt">&lt;filter&gt;</span>cert<span class="nt">&lt;/filter&gt;</span> <span class="c">&lt;!--add this line --&gt;</span>
    <span class="nt">&lt;filter&gt;</span>form<span class="nt">&lt;/filter&gt;</span>
    <span class="nt">&lt;filter&gt;</span>anonymous<span class="nt">&lt;/filter&gt;</span>
  <span class="nt">&lt;/filters&gt;</span>
  ...
  <span class="nt">&lt;filters</span> <span class="na">name=</span><span class="s">&quot;rest&quot;</span> <span class="na">class=</span><span class="s">&quot;org.geoserver.security.ServiceLoginFilterChain&quot;</span> <span class="na">interceptorName=</span><span class="s">&quot;restInterceptor&quot;</span> <span class="na">exceptionTranslationName=</span><span class="s">&quot;exception&quot;</span> <span class="na">path=</span><span class="s">&quot;/rest/**&quot;</span> <span class="na">disabled=</span><span class="s">&quot;false&quot;</span> <span class="na">allowSessionCreation=</span><span class="s">&quot;false&quot;</span> <span class="na">ssl=</span><span class="s">&quot;false&quot;</span> <span class="na">matchHTTPMethod=</span><span class="s">&quot;false&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;filter&gt;</span>cert<span class="nt">&lt;/filter&gt;</span> <span class="c">&lt;!--add this line --&gt;</span>
    <span class="nt">&lt;filter&gt;</span>basic<span class="nt">&lt;/filter&gt;</span>
    <span class="nt">&lt;filter&gt;</span>anonymous<span class="nt">&lt;/filter&gt;</span>
  <span class="nt">&lt;/filters&gt;</span>
  <span class="nt">&lt;filters</span> <span class="na">name=</span><span class="s">&quot;gwc&quot;</span> <span class="na">class=</span><span class="s">&quot;org.geoserver.security.ServiceLoginFilterChain&quot;</span> <span class="na">interceptorName=</span><span class="s">&quot;restInterceptor&quot;</span> <span class="na">exceptionTranslationName=</span><span class="s">&quot;exception&quot;</span> <span class="na">path=</span><span class="s">&quot;/gwc/rest/**&quot;</span> <span class="na">disabled=</span><span class="s">&quot;false&quot;</span> <span class="na">allowSessionCreation=</span><span class="s">&quot;false&quot;</span> <span class="na">ssl=</span><span class="s">&quot;false&quot;</span> <span class="na">matchHTTPMethod=</span><span class="s">&quot;false&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;filter&gt;</span>cert<span class="nt">&lt;/filter&gt;</span> <span class="c">&lt;!--add this line --&gt;</span>
    <span class="nt">&lt;filter&gt;</span>basic<span class="nt">&lt;/filter&gt;</span>
  <span class="nt">&lt;/filters&gt;</span>
  <span class="nt">&lt;filters</span> <span class="na">name=</span><span class="s">&quot;default&quot;</span> <span class="na">class=</span><span class="s">&quot;org.geoserver.security.ServiceLoginFilterChain&quot;</span> <span class="na">interceptorName=</span><span class="s">&quot;interceptor&quot;</span> <span class="na">exceptionTranslationName=</span><span class="s">&quot;exception&quot;</span> <span class="na">path=</span><span class="s">&quot;/**&quot;</span> <span class="na">disabled=</span><span class="s">&quot;false&quot;</span> <span class="na">allowSessionCreation=</span><span class="s">&quot;false&quot;</span> <span class="na">ssl=</span><span class="s">&quot;false&quot;</span> <span class="na">matchHTTPMethod=</span><span class="s">&quot;false&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;filter&gt;</span>cert<span class="nt">&lt;/filter&gt;</span> <span class="c">&lt;!--add this line --&gt;</span>
    <span class="nt">&lt;filter&gt;</span>basic<span class="nt">&lt;/filter&gt;</span>
    <span class="nt">&lt;filter&gt;</span>anonymous<span class="nt">&lt;/filter&gt;</span>
  <span class="nt">&lt;/filters&gt;</span>
<span class="nt">&lt;/filterChain&gt;</span>
</pre></div>
</div>
<ol class="arabic simple" start="4">
<li>Restart GeoServer.</li>
<li>Verify that the &#8216;web&#8217; filter chain has the &#8216;cert&#8217; filter selected.</li>
</ol>
</div>
<div class="section" id="install-an-ldap-server-for-storing-authorizations">
<h3>Install an LDAP Server for Storing Authorizations<a class="headerlink" href="#install-an-ldap-server-for-storing-authorizations" title="Permalink to this headline">¶</a></h3>
<p><em>Note: If you are already have an LDAP server set up, you can skip this
step.</em></p>
<ol class="arabic simple">
<li>Download and install
<a class="reference external" href="http://directory.apache.org/apacheds/">ApacheDS</a></li>
<li>Either run as a service, or run through the start scripts:</li>
</ol>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span><span class="nb">cd </span>apacheds-2.0.0-M20/bin
<span class="nv">$ </span>chmod <span class="m">755</span> *.sh
<span class="nv">$ </span>./apacheds.sh
</pre></div>
</div>
</div>
<div class="section" id="configure-ldap-for-storing-authorizations">
<h3>Configure LDAP for Storing Authorizations<a class="headerlink" href="#configure-ldap-for-storing-authorizations" title="Permalink to this headline">¶</a></h3>
<p>We want to configure LDAP with a user to match the Spring Security PKIs
we are testing with. The end result we want is to create the following
user:</p>
<p><code class="docutils literal"><span class="pre">DN:</span> <span class="pre">cn=rod,ou=Spring</span> <span class="pre">Security,o=Spring</span> <span class="pre">Framework</span></code></p>
<p>In order to do that, we will use Apache Directory Studio.</p>
<ol class="arabic">
<li><p class="first">Download and run <a class="reference external" href="http://directory.apache.org/studio/">Apache Directory
Studio</a>.</p>
</li>
<li><p class="first">Connect to the your LDAP instance (ApacheDS), using the instructions
<a class="reference external" href="http://directory.apache.org/apacheds/basic-ug/1.4.2-changing-admin-password.html">here</a>
(note: you do not need to change the password unless you want to).</p>
</li>
<li><p class="first">Create a partition for our data:</p>
<ol class="arabic simple">
<li>Right-click the &#8216;ApacheDS (localhost)&#8217; entry under the
&#8216;Connection&#8217; tab and select &#8216;Open Configuration&#8217;.</li>
<li>Click &#8216;Advanced Partitions Configuration...&#8217;.</li>
<li>Click &#8216;Add&#8217;.</li>
<li>Set the ID field to be &#8216;Spring Framework&#8217;.</li>
<li>Set the Suffix field to be &#8216;o=Spring Framework&#8217;.</li>
<li>Uncheck &#8216;Auto-generate context entry from suffix DN&#8217;.</li>
<li>Set the following attributes in Context Entry:<ul>
<li>objectclass: extensibleObject</li>
<li>objectclass: top</li>
<li>objectclass: domain</li>
<li>dc: Spring Framework2</li>
<li>o: Spring Framework2</li>
</ul>
</li>
<li>Hit <strong>Ctrl-s</strong> to save the partition.</li>
</ol>
<p><img alt="ApacheDS Partition" src="../_images/apache-ds-partition.png" /></p>
</li>
<li><p class="first"><strong>Restart ApacheDS.</strong> Otherwise the partition will not be available
and the LDIF import will fail.</p>
</li>
<li><p class="first">Load the LDIF file
<a class="reference download internal" href="../_downloads/spring-security-rod.ldif"><code class="xref download docutils literal"><span class="pre">spring-security-rod.ldif</span></code></a>,
which will create the Spring Security OU and the &#8216;rod&#8217; user:</p>
<ul class="simple">
<li>Right-click the &#8216;Root DSE&#8217; node in the LDAP browser, and select
&#8216;Import-&gt;LDIF import...&#8217;</li>
</ul>
</li>
</ol>
</div>
<div class="section" id="test-ldap-connection-using-tutorial-code">
<h3>Test LDAP Connection Using Tutorial Code<a class="headerlink" href="#test-ldap-connection-using-tutorial-code" title="Permalink to this headline">¶</a></h3>
<p>The tutorial code includes an <code class="docutils literal"><span class="pre">AuthorizationsProvider</span></code> implementation
that will connect to LDAP to retrieve authorizations, in the class
<code class="docutils literal"><span class="pre">com.example.geomesa.authorizations.LdapAuthorizationsProvider</span></code>.</p>
<p>The provider will configure itself based on the
<code class="docutils literal"><span class="pre">geomesa-ldap.properties</span></code> file on the classpath (under
<code class="docutils literal"><span class="pre">src/main/resources</span></code>):</p>
<div class="highlight-properties"><div class="highlight"><pre><span class="c"># ldap connection properties</span>
<span class="na">java.naming.factory.initial</span><span class="o">=</span><span class="s">com.sun.jndi.ldap.LdapCtxFactory</span>
<span class="na">java.naming.provider.url</span><span class="o">=</span><span class="s">ldap://localhost:10389</span>
<span class="na">java.naming.security.authentication</span><span class="o">=</span><span class="s">simple</span>
<span class="na">java.naming.security.principal</span><span class="o">=</span><span class="s">uid=admin,ou=system</span>
<span class="na">java.naming.security.credentials</span><span class="o">=</span><span class="s">secret</span>

<span class="c"># the ldap node to start the query from</span>
<span class="na">geomesa.ldap.search.root</span><span class="o">=</span><span class="s">o=Spring Framework</span>
<span class="c"># the query that will be applied to find the user&#39;s record</span>
<span class="c"># the &#39;{}&#39; will be replaced with the common name from the certificate the user has logged into geoserver with</span>
<span class="na">geomesa.ldap.search.filter</span><span class="o">=</span><span class="s">(&amp;(objectClass=person)(cn={}))</span>
<span class="c"># the ldap attribute that holds the comma-delimited authorizations for the user</span>
<span class="na">geomesa.ldap.auths.attribute</span><span class="o">=</span><span class="s">employeeType</span>
</pre></div>
</div>
<p>The default file included with the tutorial will connect to the LDAP
instance we set up in the previous steps. If you are using a different
LDAP configuration, you will need to modify the file appropriately.</p>
<p>The <code class="docutils literal"><span class="pre">LdapAuthorizationsProvider</span></code> will look for a particular LDAP
attribute that stores the user&#8217;s authorizations in a comma-delimited
list. For simplicity, in this tutorial we have re-purposed an existing
attribute, <code class="docutils literal"><span class="pre">employeeType</span></code>. The attribute to use can be modified
through the property file.</p>
<p>When we inserted the &#8216;rod&#8217; record into LDAP, we set his <code class="docutils literal"><span class="pre">employeeType</span></code>
to &#8216;user,admin&#8217;, corresponding to our Accumulo authorizations. If you
are using different authorizations, you will need to update the
attribute to match.</p>
<p>The tutorial code includes a test case for connecting to LDAP, in the
class <code class="docutils literal"><span class="pre">com.example.geomesa.authorizations.LdapAuthorizationsProviderTest</span></code>.</p>
<p>Once you have modified <code class="docutils literal"><span class="pre">geomesa-ldap.properties</span></code> to connect to your
LDAP, you can test the connection by running this test class:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>java -cp ./target/geomesa-examples-authorizations-<span class="nv">$VERSION</span>.jar <span class="se">\</span>
   com.example.geomesa.authorizations.LdapAuthorizationsProviderTest rod
</pre></div>
</div>
<p>The argument to the program (&#8216;rod&#8217;) is the user to retrieve
authorizations for. You should get the following output:</p>
<div class="highlight-bash"><div class="highlight"><pre>Checking auths from LDAP <span class="k">for</span> user <span class="s1">&#39;rod&#39;</span>
Retrieved auths: user,admin
</pre></div>
</div>
</div>
<div class="section" id="installing-the-ldap-authorizationprovider-in-geoserver">
<h3>Installing the LDAP AuthorizationProvider in GeoServer<a class="headerlink" href="#installing-the-ldap-authorizationprovider-in-geoserver" title="Permalink to this headline">¶</a></h3>
<p>In order to use the <code class="docutils literal"><span class="pre">LdapAuthorizationsProvider</span></code>, we need to install
it as a service provider into GeoServer, where it will automatically be
picked up by GeoMesa.</p>
<p>The tutorial code includes a service provider registry in the
<code class="docutils literal"><span class="pre">META-INF/services</span></code> folder. By default, the provider class is
specified as the <code class="docutils literal"><span class="pre">EmptyAuthorizationsProvider</span></code>.</p>
<ol class="arabic simple">
<li>Ensure that your LDAP configuration is correct by running
<code class="docutils literal"><span class="pre">LdapAuthorizationsProviderTest</span></code>, as described above.</li>
<li>Change the provider class in
<code class="docutils literal"><span class="pre">src/main/resources/META-INF/services/geomesa.core.security.AuthorizationsProvider</span></code>
to be <code class="docutils literal"><span class="pre">com.example.geomesa.authorizations.LdapAuthorizationsProvider</span></code>.</li>
<li>Rebuild the tutorial JAR and install the unshaded original jar in
GeoServer:</li>
</ol>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>mvn clean install
<span class="nv">$ </span>cp ./target/original-geomesa-examples-authorizations-<span class="nv">$VERSION</span>.jar <span class="se">\</span>
   /path/to/tomcat/webapps/geoserver/WEB-INF/lib/
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">We want to use the unshaded jar since all the required
dependencies are already installed in GeoServer.</p>
</div>
<ol class="arabic simple" start="4">
<li>Restart GeoServer (or start it if it is not running).</li>
</ol>
<p>At this point you should have everything configured and in-place.</p>
</div>
<div class="section" id="verifying-the-ldap-authorizations-in-geoserver">
<h3>Verifying the LDAP Authorizations in GeoServer<a class="headerlink" href="#verifying-the-ldap-authorizations-in-geoserver" title="Permalink to this headline">¶</a></h3>
<p>In order to verify that the authorizations are working correctly,
execute a query against GeoMesa by calling the WMS provider over HTTPS
in your browser:</p>
<div class="highlight-bash"><div class="highlight"><pre>https://localhost:8443/geoserver/wms?service<span class="o">=</span>WMS<span class="p">&amp;</span><span class="nv">version</span><span class="o">=</span>1.1.0<span class="p">&amp;</span><span class="nv">request</span><span class="o">=</span>GetMap<span class="p">&amp;</span><span class="nv">layers</span><span class="o">=</span>geomesa:gdelt_auths<span class="p">&amp;</span><span class="nv">styles</span><span class="o">=</span><span class="p">&amp;</span><span class="nv">bbox</span><span class="o">=</span>31.6,44,37.4,47.75<span class="p">&amp;</span><span class="nv">width</span><span class="o">=</span>1200<span class="p">&amp;</span><span class="nv">height</span><span class="o">=</span>600<span class="p">&amp;</span><span class="nv">srs</span><span class="o">=</span>EPSG:4326<span class="p">&amp;</span><span class="nv">format</span><span class="o">=</span>application/openlayers<span class="p">&amp;</span><span class="nv">TIME</span><span class="o">=</span>2013-01-01T00:00:00.000Z/2014-04-30T23:00:00.000Z
</pre></div>
</div>
<p>When prompted, select the &#8216;rod&#8217; certificate.</p>
<p>You should see the normal data come back, with many red points
indicating the data:</p>
<div class="figure" id="id2">
<img alt="Authorized Results" src="../_images/Ukraine_Unfiltered.png" />
<p class="caption"><span class="caption-text">Authorized Results</span></p>
</div>
<p>Now try the same query, but use the &#8216;scott&#8217; certificate. This time,
there should be no data returned, as the &#8216;scott&#8217; user does not have any
authorizations set up in LDAP.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">A simple way to use different certificates at once is to open
multiple &#8216;incognito&#8217; or &#8216;private&#8217; browser windows.</p>
</div>
</div>
</div>
<div class="section" id="querying-geoserver-through-a-web-feature-service-wfs-with-a-java-client">
<h2>Querying GeoServer through a Web Feature Service (WFS) with a Java Client<a class="headerlink" href="#querying-geoserver-through-a-web-feature-service-wfs-with-a-java-client" title="Permalink to this headline">¶</a></h2>
<p>GeoServer provides the ability to query data through a Web Feature
Service (WFS). Using GeoTools, we can create a client in Java through a
WFSDataStore. More details are available
<a class="reference external" href="http://docs.geotools.org/latest/userguide/library/data/wfs.html">here</a>
and
<a class="reference external" href="http://docs.geoserver.org/stable/en/user/services/wfs/reference.html">here</a>,
although some of the documentation is out of date.</p>
<p>We can leverage the same PKI and LDAP setup that we used through the web
interface to authenticate our client.</p>
<p>Go back to the tutorial folder, and execute the following command:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>java -cp ./target/geomesa-examples-authorizations-1.0-SNAPSHOT.jar <span class="se">\</span>
   -Djavax.net.ssl.keyStore<span class="o">=</span>/path/to/certs/rod.p12 <span class="se">\</span>
   -Djavax.net.ssl.keyStorePassword<span class="o">=</span>password <span class="se">\</span>
   -Djavax.net.ssl.keyStoreType<span class="o">=</span>PKCS12 <span class="se">\</span>
   -Djavax.net.ssl.trustStore<span class="o">=</span>/path/to/certs/server.jks <span class="se">\</span>
   -Djavax.net.ssl.trustStorePassword<span class="o">=</span>password <span class="se">\</span>
   -Djavax.net.ssl.trustStoreType<span class="o">=</span>JKS
   com.example.geomesa.authorizations.GeoServerAuthorizationsTutorial <span class="se">\</span>
   -geoserverUrl &lt;url&gt; <span class="se">\</span>
   -featureStore &lt;featureStore&gt; <span class="se">\</span>
</pre></div>
</div>
<p>where you provide the following arguments:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">&lt;url&gt;</span></code>: the <strong>HTTPS</strong> path to GeoServer, e.g.
<code class="docutils literal"><span class="pre">https://localhost:8443/geoserver/</span></code></li>
<li><code class="docutils literal"><span class="pre">&lt;featureStore&gt;</span></code>: the name of the data store created in GeoServer,
including the workspace, e.g. <code class="docutils literal"><span class="pre">geomesa:gdelt</span></code></li>
<li><code class="docutils literal"><span class="pre">javax.net.ssl.*</span></code>: SSL configuration system properties. Note that
these need to be before the class name, otherwise they will be
treated as arguments to the program.</li>
</ul>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last"><strong>Ensure that the URL for GeoServer is using HTTPS.</strong></p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The feature store needs to be namespaced with the GeoServer
workspace. The workspace and store name are separated with a colon.</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">If you happen to have two GeoServer data stores with the same
name but different workspaces, you will need to delete or rename one of
them. There is a bug in GeoServer where it might return the wrong
features if there are two data stores with the same name.</p>
</div>
<p>The system properties will control the keystore that is used for
authentication. For the first command, we are using the <code class="docutils literal"><span class="pre">rod.p12</span></code>
certificate. Upon execution, you should see the following output:</p>
<div class="highlight-bash"><div class="highlight"><pre>Executing query against <span class="s1">&#39;https://localhost:8443/geoserver/wfs?request=GetCapabilities&amp;version=1.0.0&#39;</span> with client keystore <span class="s1">&#39;/path/to/certs/rod.p12&#39;</span>
INFO: Cached XML schema: https://localhost:8443/geoserver/wfs?service<span class="o">=</span>WFS<span class="p">&amp;</span><span class="nv">version</span><span class="o">=</span>1.0.0<span class="p">&amp;</span><span class="nv">request</span><span class="o">=</span>DescribeFeatureType<span class="p">&amp;</span><span class="nv">typeName</span><span class="o">=</span>geomesa%3Agdelt
Results:
1<span class="p">|</span><span class="nv">geom</span><span class="o">=</span>POINT <span class="o">(</span>33.9744 45.2908<span class="o">)</span>
</pre></div>
</div>
<p>If you re-execute the command, but use the <code class="docutils literal"><span class="pre">scott.p12</span></code> cert instead,
you should get no results:</p>
<div class="highlight-bash"><div class="highlight"><pre>Executing query against <span class="s1">&#39;https://localhost:8443/geoserver/wfs?request=GetCapabilities&amp;version=1.0.0&#39;</span> with client keystore <span class="s1">&#39;/path/to/certs/scott.p12&#39;</span>
INFO: Cached XML schema: https://localhost:8443/geoserver/wfs?service<span class="o">=</span>WFS<span class="p">&amp;</span><span class="nv">version</span><span class="o">=</span>1.0.0<span class="p">&amp;</span><span class="nv">request</span><span class="o">=</span>DescribeFeatureType<span class="p">&amp;</span><span class="nv">typeName</span><span class="o">=</span>geomesa%3Agdelt
No results
</pre></div>
</div>
</div>
<div class="section" id="id1">
<h2>Looking Closer at the Code<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h2>
<p>The code for querying through WFS is available in the class
<code class="docutils literal"><span class="pre">com.example.geomesa.authorizations.GeoServerAuthorizationsTutorial</span></code>. The interesting
code for this tutorial is contained in the <code class="docutils literal"><span class="pre">main</span></code> method:</p>
<div class="highlight-java"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14</pre></div></td><td class="code"><div class="highlight"><pre><span class="c1">// create the URL to GeoServer. Note that we need to point to the &#39;GetCapabilities&#39; request,</span>
<span class="c1">// and that we are using WFS version 1.0.0</span>
<span class="n">String</span> <span class="n">geoserverUrl</span> <span class="o">=</span> <span class="n">geoserverHost</span> <span class="o">+</span> <span class="s">&quot;wfs?request=GetCapabilities&amp;version=1.0.0&quot;</span><span class="o">;</span>

<span class="c1">// create the geotools configuration for a WFS data store</span>
<span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">configuration</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;();</span>
<span class="n">configuration</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">WFSDataStoreFactory</span><span class="o">.</span><span class="na">URL</span><span class="o">.</span><span class="na">key</span><span class="o">,</span> <span class="n">geoserverUrl</span><span class="o">);</span>
<span class="n">configuration</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">WFSDataStoreFactory</span><span class="o">.</span><span class="na">WFS_STRATEGY</span><span class="o">.</span><span class="na">key</span><span class="o">,</span> <span class="s">&quot;geoserver&quot;</span><span class="o">);</span>
<span class="n">configuration</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">WFSDataStoreFactory</span><span class="o">.</span><span class="na">TIMEOUT</span><span class="o">.</span><span class="na">key</span><span class="o">,</span> <span class="n">cmd</span><span class="o">.</span><span class="na">getOptionValue</span><span class="o">(</span><span class="n">SetupUtil</span><span class="o">.</span><span class="na">TIMEOUT</span><span class="o">,</span> <span class="s">&quot;99999&quot;</span><span class="o">));</span>

<span class="c1">//...</span>

<span class="c1">// verify we have gotten the correct datastore</span>
<span class="n">WFSDataStore</span> <span class="n">wfsDataStore</span> <span class="o">=</span> <span class="o">(</span><span class="n">WFSDataStore</span><span class="o">)</span> <span class="n">DataStoreFinder</span><span class="o">.</span><span class="na">getDataStore</span><span class="o">(</span><span class="n">configuration</span><span class="o">);</span>
</pre></div>
</td></tr></table></div>
<p>This code snippet shows how you can get a GeoTools <code class="docutils literal"><span class="pre">DataStore</span></code> that
connects to GeoServer through WFS. Once you have obtained the data
store, you can query it just like any other data store, and the
implementation details will be transparent.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="geomesa-feature-level-visibility.html" title="Feature Level Visibility &amp; Security"
             >next</a> |</li>
        <li class="right" >
          <a href="geomesa-tubeselect.html" title="Web Processing Services (WPS) Tube Select"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">GeoMesa 1.2.0 Manuals</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="index.html" >GeoMesa 1.2.0 Tutorials</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &copy; Copyright 2015, GeoMesa.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.3.3.
    </div>
  </body>
</html>