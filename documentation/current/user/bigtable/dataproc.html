

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>GeoMesa Spark SQL on Google Cloud Dataproc &mdash; GeoMesa 1.3.2-SNAPSHOT Manuals</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../_static/css/theme_custom.css" type="text/css" />
  

  
    <link rel="stylesheet" href="../../_static/sphinx_tabs/tabs.css" type="text/css" />
  
    <link rel="stylesheet" href="../../_static/sphinx_tabs/semantic-ui-2.2.7/segment.min.css" type="text/css" />
  
    <link rel="stylesheet" href="../../_static/sphinx_tabs/semantic-ui-2.2.7/menu.min.css" type="text/css" />
  
    <link rel="stylesheet" href="../../_static/sphinx_tabs/semantic-ui-2.2.7/tab.min.css" type="text/css" />
  

  
    <link rel="top" title="GeoMesa 1.3.2-SNAPSHOT Manuals" href="../../index.html"/> 

  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../index.html" class="icon icon-home"> GeoMesa
          

          
          </a>

          
            
            
              <div class="version">
                1.3.2-SNAPSHOT
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul>
<li class="toctree-l1"><a class="reference internal" href="../index.html">User Manual</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../developer/index.html">Developer Manual</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tutorials/index.html">Tutorials</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../index.html">GeoMesa</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          





<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../index.html">Docs</a> &raquo;</li>
      
    <li>GeoMesa Spark SQL on Google Cloud Dataproc</li>
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../../_sources/user/bigtable/dataproc.txt" rel="nofollow"> View page source</a>
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="geomesa-spark-sql-on-google-cloud-dataproc">
<h1>GeoMesa Spark SQL on Google Cloud Dataproc<a class="headerlink" href="#geomesa-spark-sql-on-google-cloud-dataproc" title="Permalink to this headline">Â¶</a></h1>
<p>GeoMesa can run Spark SQL with Bigtable as the underlying datastore.  In order to set up Spark SQL,
you will need to launch a Google Cloud Dataproc cluster.  First, you will need to install the Google
Cloud SDK command line tools.  Instructions for doing so can be found <a class="reference external" href="https://cloud.google.com/sdk/downloads">here</a>.
Ensure that you have installed all the appropriate components for working with GCP Bigtable and GCP
Dataproc.</p>
<div class="highlight-shell"><div class="highlight"><pre>$ gcloud components install cbt
$ gcloud components install alpha
$ gcloud components install beta
</pre></div>
</div>
<p>Then, provision a new Bigtable instance.</p>
<div class="highlight-shell"><div class="highlight"><pre>$ gcloud beta bigtable instances create geomesa --cluster geomesa --cluster-zone us-east1-b --cluster-num-nodes 3 --description GeoMesa
</pre></div>
</div>
<p>And provision a GCP Dataproc cluster.</p>
<div class="highlight-shell"><div class="highlight"><pre>$ gcloud dataproc clusters create geomesa
</pre></div>
</div>
<p>Once you have a GCP Dataproc cluster up and running, you can scp the GeoMesa Bigtable distribution to the master node.  You can
determine the name of the master node by using the following command line.</p>
<div class="highlight-shell"><div class="highlight"><pre>$ gcloud compute instances list
</pre></div>
</div>
<p>Find the master node instance and then scp the distro as follows.</p>
<div class="highlight-shell"><div class="highlight"><pre>$ gcloud beta compute scp --zone $ZONEID  ~/.m2/repository/org/locationtech/geomesa/geomesa-bigtable-dist_2.11/$VERSION/geomesa-bigtable-dist_2.11-$VERSION-bin.tar.gz &lt;masterhost&gt;:~/
</pre></div>
</div>
<p>Log in to the master node using gcloud ssh as follows.</p>
<div class="highlight-shell"><div class="highlight"><pre>$ gcloud compute --project $PROJECTID ssh --zone $ZONEID $MASTER
</pre></div>
</div>
<p>Now, configure the installation by unpacking the tarball, editing the hbase-site.xml appropriately, and including the hbase-site.xml in the
spark runtime jar.</p>
<div class="highlight-shell"><div class="highlight"><pre>$ tar zxvf geomesa-bigtable-dist_2.11-$VERSION-bin.tar.gz
$ ln -s geomesa-bigtable_2.11-$VERSION geomesa
$ export PATH=$PATH:~/geomesa/bin
$ export HADOOP_HOME=/usr/lib/hadoop
$ export HBASE_HOME=/usr/lib/hbase
$ vi geomesa/conf/hbase-site.xml
$ cp geomesa/conf/hbase-site.xml geomesa/dist/spark/
$ cd geomesa/dist/spark/
$ jar uvf geomesa-hbase-spark-runtime_2.11-$VERSION hbase-site.xml
</pre></div>
</div>
<p>Download sample GDELT data and ingest it as follows.</p>
<div class="highlight-shell"><div class="highlight"><pre>$ geomesa-bigtable ingest -t 8 -c geomesa.gdelt -s gdelt -C gdelt \*.csv
</pre></div>
</div>
<p>Now, you can run a spark shell and execute Spark SQL over your GeoMesa on Bigtable instance.  Set the version to your installed version of GeoMesa.</p>
<div class="highlight-shell"><div class="highlight"><pre>$ spark-shell --num-executors 4 --master yarn --jars file://$HOME/geomesa/dist/spark/geomesa-hbase-spark-runtime_2.11-$VERSION.jar,file://$HOME/geomesa/lib/bigtable-hbase-1.2-0.9.4.jar,file://$HOME/geomesa/lib/netty-tcnative-boringssl-static-1.1.33.Fork19.jar
</pre></div>
</div>
<p>From the Spark shell prompt.</p>
<div class="highlight-shell"><div class="highlight"><pre>scala&gt; System.setProperty(&quot;geomesa.scan.ranges.target&quot;, &quot;1&quot;)
scala&gt; val df = spark.read.format(&quot;geomesa&quot;).option(&quot;bigtable.table.name&quot;, &quot;geomesa.gdelt&quot;).option(&quot;geomesa.feature&quot;, &quot;gdelt&quot;).load()
scala&gt; df.createOrReplaceTempView(&quot;gdelt&quot;)
scala&gt; spark.sql(&quot;SELECT actor1Name,actor2Name,geom,dtg FROM gdelt WHERE st_contains(st_geomFromWKT(&#39;POLYGON((-80 35,-70 35,-70 40,-80 40,-80 35))&#39;),geom)&quot;).show()
</pre></div>
</div>
</div>


           </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2013-2017 Commonwealth Computer Research, Inc.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'1.3.2-SNAPSHOT',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>
      <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
      <script type="text/javascript" src="../../_static/sphinx_tabs/tabs.js"></script>
      <script type="text/javascript" src="../../_static/sphinx_tabs/semantic-ui-2.2.7/tab.min.js"></script>

  

  
  
    <script type="text/javascript" src="../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>